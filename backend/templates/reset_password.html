<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Samarth Aushadhalay</title>
    <!--link to CSS-->
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/login.css') }}">

    <!-- Box Icon -->
    <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
</head>
<body>
    <!-- Navbar -->
    <header>
        <!-- Profile -->
        <div class="profile">
          <img src="{{ url_for('static', filename='img/logo_srividya_(1).png') }}" alt="">
          <span>SAMARTH AUSHADHALAY</span>
        </div>
          <!-- menu icon -->
          <div class="bx bx-menu" id="menu-icon"></div>
          <!-- Nav List -->
           <ul class="navbar">
              <li><a href="index.html">Home</a></li>
              <li><a href="products.html">Products</a></li>
              <li><a href="about.html">About</a></li>
              <li><a href="cart.html">Cart</a></li>
              <li><a href="order_history.html">My Orders</a></li>
           </ul>
           <!-- Header Icon -->
            <div class="header-icons">
              {% if session.get('username') %}
              <div class="logged-in-user-info">
                <span>Hello, {{ session['username'] }}</span>
                <a href="#" id="logout-icon" onclick="event.preventDefault(); document.getElementById('logout-form').submit();"><i class='bx bx-log-out'></i></a>
                <form id="logout-form" action="{{ url_for('auth.logout') }}" method="POST" style="display: none;"></form>
              </div>
              {% else %}
              <a href="login.html" class="user-icon-active"><i class='bx bx-user' id="user-icon"></i></a>
              {% endif %}
              <i class='bx bx-menu' id="menu-icon"></i>

            </div>
            
      </header>
       <!-- User -->
       <section class="user" id="user" style="
          background-image: url('{{ url_for('static', filename='img/login.jpg') }}');
          background-repeat: no-repeat;
          background-size: cover;
          background-position: center;
       ">
        <div class="user-text">
        <h2>Reset Password</h2>
        <form id="resetPasswordForm">
            <input type="password" id="password" name="password" placeholder="Enter new password" required>
            <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm new password" required>
            <input type="submit" value="Reset Password" class="login-btn">
        </form>
        <p id="message" style="color: red; text-align: center; margin-top: 10px;"></p>
        </div>
      </section>

      <script>
        document.getElementById('resetPasswordForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const messageElement = document.getElementById('message');
            messageElement.textContent = ''; // Clear previous messages

            if (password !== confirmPassword) {
                messageElement.style.color = 'red';
                messageElement.textContent = 'Passwords do not match!';
                return;
            }

            // Extract token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                messageElement.style.color = 'red';
                messageElement.textContent = 'Reset token is missing.';
                return;
            }

            try {
                const response = await fetch(`/auth/reset_password/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    messageElement.style.color = 'green';
                    messageElement.textContent = data.message + ' Redirecting to login...';
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 3000);
                } else {
                    messageElement.style.color = 'red';
                    messageElement.textContent = 'Error: ' + (data.message || response.statusText);
                }
            } catch (err) {
                console.error('Reset password error:', err);
                messageElement.style.color = 'red';
                messageElement.textContent = 'An error occurred. Please try again.';
            }
        });
      </script>

</body>
</html>